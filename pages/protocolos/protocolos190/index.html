<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
  <title>SISP - Roteiros 193</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/roteiros.css">

</head>
<body>
  <!-- TOPO -->
  <header class="header">
    <div class="header-left">
      <div class="header-logo-text">
        <div class="header-logo-text-main">SISP</div>
        <div class="header-logo-text-sub">
          SISTEMA INTEGRADO<br>DE SEGURAN√áA P√öBLICA
        </div>
      </div>
    </div>
    <div class="header-right">
      CORPO DE BOMBEIROS MILITAR<br>Minas Gerais
    </div>
  </header>

  <!-- CONTE√öDO -->
  <div class="container-fluid">
    <div class="row">
      <!-- SIDEBAR -->
      <aside class="col-12 col-md-3 sidebar">
        <div class="sidebar-title">NATUREZAS</div>
        <input id="buscaInput" class="form-control form-control-sm mb-2"
               placeholder="Filtrar c√≥digo ou t√≠tulo...">

        <div id="groupList"></div>
      </aside>

      <!-- √ÅREA PRINCIPAL -->
      <main class="col-12 col-md-9 content">
        <div id="detalhesContainer" class="placeholder">
          <div class="placeholder-icon">üóÇÔ∏è</div>
          <h5>Roteiros de Atendimento 193</h5>
          <p>Selecione um c√≥digo na lateral para visualizar o roteiro.</p>
        </div>
      </main>
    </div>
  </div>

  <script>
  let dadosRoteiros = [];
  let grupoSelecionado = null;
  let naturezaSelecionada = null;
  let dadosPorGrupo = {};

  // Carrega o JSON gerado a partir do Excel
  fetch('roteiros190.json')
    .then(resp => resp.json())
    .then(data => {
      // Converte campos MAI√öSCULOS do JSON 190
      dadosRoteiros = data
        .map(item => ({
          grupo: (item.GRUPO || '').trim(),
          codigo: (item.NATUREZA || '').trim(),
          titulo: (item['T√çTULO'] || '').trim(),
          descricao: (item['DESCRI√á√ÉO'] || '').trim(),
          acoes: (item['A√á√ïES'] || '').trim(),
          atendimento: (item['ATENDIMENTO LOCAL PELA PM'] || '').trim(),
          localEncerramento: (item['LOCAL DE ENCERRAMENTO'] || '').trim()
        }))
        .filter(item => item.grupo && item.codigo);

      prepararDados();
      renderizarGrupos();
    })
    .catch(err => {
      console.error('Erro ao carregar roteiros190.json:', err);
      document.getElementById('detalhesContainer').innerHTML =
        '<p class="text-danger">Erro ao carregar os roteiros. Verifique se o arquivo <strong>roteiros190.json</strong> est√° na mesma pasta.</p>';
    });

  function prepararDados() {
    dadosPorGrupo = {};
    dadosRoteiros.forEach(item => {
      const grupo = item.grupo;
      if (!dadosPorGrupo[grupo]) {
        dadosPorGrupo[grupo] = [];
      }
      dadosPorGrupo[grupo].push(item);
    });

    Object.keys(dadosPorGrupo).forEach(grupo => {
      dadosPorGrupo[grupo].sort((a, b) => a.codigo.localeCompare(b.codigo));
    });
  }

  function renderizarGrupos(filtroTexto = '') {
    const groupList = document.getElementById('groupList');
    groupList.innerHTML = '';

    const gruposOrdenados = Object.keys(dadosPorGrupo).sort();

    gruposOrdenados.forEach(grupo => {
      const listaNaturezas = dadosPorGrupo[grupo];

      // Se h√° filtro, s√≥ mostra grupo que tenha algum item compat√≠vel
      const temMatch = listaNaturezas.some(item => {
        const txt = (item.codigo + ' ' + item.titulo).toLowerCase();
        return txt.includes(filtroTexto.toLowerCase());
      });
      if (filtroTexto && !temMatch) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'group-wrapper';

      const count = listaNaturezas.length;

      const btn = document.createElement('button');
      btn.className = 'btn btn-light btn-sm d-flex align-items-center group-btn' +
                      (grupo === grupoSelecionado ? ' active' : '');
      btn.innerHTML = `
        <span>C√ìDIGO ${grupo}</span>
        <span class="badge rounded-pill badge-count">${count}</span>
      `;

      // Sublista de naturezas logo abaixo do grupo
      const subList = document.createElement('div');
      subList.className = 'natureza-list';

      if (grupo === grupoSelecionado) {
        renderizarNaturezas(listaNaturezas, filtroTexto, subList);
      } else {
        subList.style.display = 'none';
      }

      btn.addEventListener('click', () => {
        const filtroAtual = document.getElementById('buscaInput').value.trim();

        // alterna sele√ß√£o do grupo
        if (grupoSelecionado === grupo) {
          grupoSelecionado = null;
          naturezaSelecionada = null;
          document.getElementById('detalhesContainer').className = 'placeholder';
          document.getElementById('detalhesContainer').innerHTML = `
            <div class="placeholder-icon">üóÇÔ∏è</div>
            <h5>Roteiros de Atendimento 193</h5>
            <p>Selecione um c√≥digo na lateral para visualizar o roteiro.</p>
          `;
        } else {
          grupoSelecionado = grupo;
          naturezaSelecionada = null;
          mostrarPlaceholderGrupo(grupo);
        }

        renderizarGrupos(filtroAtual);
      });

      wrapper.appendChild(btn);
      wrapper.appendChild(subList);
      groupList.appendChild(wrapper);
    });
  }

  function renderizarNaturezas(listaNaturezas, filtroTexto, container) {
    container.innerHTML = '';

    listaNaturezas.forEach(item => {
      const txt = (item.codigo + ' ' + item.titulo).toLowerCase();
      if (filtroTexto && !txt.includes(filtroTexto.toLowerCase())) return;

      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-light natureza-item border d-block' +
                      (naturezaSelecionada === item.codigo ? ' active' : '');
      btn.innerHTML = `
        <strong>${item.codigo}</strong>
        <small>${item.titulo}</small>
      `;
      btn.addEventListener('click', () => {
        naturezaSelecionada = item.codigo;
        atualizarSelecaoNatureza();
        mostrarDetalhes(item);
      });

      container.appendChild(btn);
    });

    if (!container.innerHTML) {
      container.innerHTML = '<small class="text-muted">Nenhuma natureza encontrada para este filtro.</small>';
    }
  }

  function atualizarSelecaoNatureza() {
    document.querySelectorAll('.natureza-item').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.natureza-item').forEach(btn => {
      if (btn.querySelector('strong') && btn.querySelector('strong').textContent === naturezaSelecionada) {
        btn.classList.add('active');
      }
    });
  }

  function mostrarPlaceholderGrupo(grupo) {
    const container = document.getElementById('detalhesContainer');
    container.classList.remove('placeholder');
    container.innerHTML = `
      <div class="placeholder-icon">üìÇ</div>
      <h5>Roteiros de Atendimento 193</h5>
      <p>Selecione uma natureza do <strong>C√ìDIGO ${grupo}</strong> na lateral para visualizar os detalhes.</p>
    `;
  }

  function mostrarDetalhes(item) {
    const dividirTexto = (texto) => {
      if (!texto) return [];

      const isMarco = (linha) => {
        const l = linha.toUpperCase();
        return (
          l.startsWith("PERGUNTAS") ||
          l.startsWith("REGISTRO NO CAD") ||
          l.startsWith("ACIONAR O SUPERVISOR") ||
          l.startsWith("ORIENTA√á√ïES")
        );
      };

      return texto
        .replace(/\r\n/g, "\n")
        .replace(/\r/g, "\n")
        .split("\n")
        .map(l => l.trim())
        .filter(l => l.length > 0)
        .map(l => {
          if (isMarco(l)) {
            return `<li class="marco-rota">${l.replace(/:$/, "")}</li>`;
          }

          if (l.startsWith("?") || l.endsWith("?")) {
            return `<li class="acao-pergunta"><span class="emoji">‚ùì</span>${l.replace(/^\?/, "")}</li>`;
          }

          return `<li><span class="emoji">‚Ä¢</span>${l}</li>`;
        })
        .join("");
    };

    const descricaoFormatada    = dividirTexto(item.descricao);
    const acoesFormatadas       = dividirTexto(item.acoes);
    const atendimentoFormatado  = dividirTexto(item.atendimento);
    const encerramentoFormatado = dividirTexto(item.localEncerramento);

    const container = document.getElementById("detalhesContainer");
    container.classList.remove("placeholder");
    container.innerHTML = `
      <div class="detalhes-cabecalho">
        <small>${item.codigo}</small>
        <h5>${item.titulo}</h5>
      </div>

      <div class="detalhes-section-title">Descri√ß√£o</div>
      <div class="detalhes-box">
        ${descricaoFormatada ? `<ul class="texto-lista">${descricaoFormatada}</ul>` :
        '<span class="text-muted">Sem descri√ß√£o cadastrada.</span>'}
      </div>

      <div class="detalhes-section-title">A√ß√µes / Perguntas</div>
      <div class="detalhes-box">
        ${acoesFormatadas ? `<ul class="texto-lista">${acoesFormatadas}</ul>` :
        '<span class="text-muted">Sem a√ß√µes cadastradas.</span>'}
      </div>

      <div class="detalhes-section-title">Atendimento local pela PM</div>
      <div class="detalhes-box">
        ${atendimentoFormatado ? `<ul class="texto-lista">${atendimentoFormatado}</ul>` :
        '<span class="text-muted">Sem informa√ß√µes cadastradas.</span>'}
      </div>

      <div class="detalhes-section-title">Local de encerramento</div>
      <div class="detalhes-box">
        ${encerramentoFormatado ? `<ul class="texto-lista">${encerramentoFormatado}</ul>` :
        '<span class="text-muted">Sem informa√ß√µes cadastradas.</span>'}
      </div>
    `;
  }

  // Filtro de busca
  document.getElementById('buscaInput').addEventListener('input', (e) => {
    const filtro = e.target.value.trim();
    renderizarGrupos(filtro);
  });
</script>

</body>
</html>

